#!/bin/bash

# –°–∫—Ä–∏–ø—Ç —Å–±–æ—Ä–∫–∏ I2P Daemon GUI
# –ê–≤—Ç–æ—Ä: I2P Community
# –í–µ—Ä—Å–∏—è: 1.0.0

set -e

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É I2P Daemon GUI..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Node.js
if ! command -v node &> /dev/null; then
    echo "‚ùå Node.js –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Node.js 16+ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é Node.js
NODE_VERSION=$(node -v | cut -d'v' -f2 | cut -d'.' -f1)
if [ "$NODE_VERSION" -lt 16 ]; then
    echo "‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è Node.js –≤–µ—Ä—Å–∏–∏ 16 –∏–ª–∏ –≤—ã—à–µ. –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: $(node -v)"
    exit 1
fi

echo "‚úÖ Node.js –≤–µ—Ä—Å–∏—è: $(node -v)"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ npm
if ! command -v npm &> /dev/null; then
    echo "‚ùå npm –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ npm –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
    exit 1
fi

echo "‚úÖ npm –≤–µ—Ä—Å–∏—è: $(npm -v)"

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
npm install

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Electron
if ! command -v electron &> /dev/null; then
    echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Electron..."
    npm install -g electron
fi

# –°–æ–±–∏—Ä–∞–µ–º React –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
echo "üî® –°–æ–±–∏—Ä–∞–µ–º React –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
npm run build

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å —Å–±–æ—Ä–∫–∏
if [ ! -d "build" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ React –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
    exit 1
fi

echo "‚úÖ React –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–æ–±—Ä–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ"

# –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–æ–≤
mkdir -p dist

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—É
PLATFORM=$(uname -s)
ARCH=$(uname -m)

echo "üñ•Ô∏è  –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: $PLATFORM $ARCH"

# –°–æ–±–∏—Ä–∞–µ–º Electron –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
case $PLATFORM in
    "Darwin")
        echo "üçé –°–æ–±–∏—Ä–∞–µ–º –¥–ª—è macOS..."
        npm run dist-mac
        ;;
    "Linux")
        echo "üêß –°–æ–±–∏—Ä–∞–µ–º –¥–ª—è Linux..."
        npm run dist-linux
        ;;
    "MINGW"*|"CYGWIN"*|"MSYS"*)
        echo "ü™ü –°–æ–±–∏—Ä–∞–µ–º –¥–ª—è Windows..."
        npm run dist-win
        ;;
    *)
        echo "‚ö†Ô∏è  –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞. –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é..."
        npm run dist
        ;;
esac

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–±–æ—Ä–∫–∏
if [ -d "dist" ] && [ "$(ls -A dist)" ]; then
    echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
    echo "üìÅ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –ø–∞–ø–∫–µ: dist/"
    ls -la dist/
else
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–∞"
    exit 1
fi

echo ""
echo "üéâ I2P Daemon GUI —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω!"
echo "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "   1. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"
echo "   2. –°–æ–∑–¥–∞–π—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–æ—á–Ω—ã–µ –ø–∞–∫–µ—Ç—ã"
echo "   3. –ü–æ–¥–ø–∏—à–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–¥–ª—è macOS/Windows)"
echo "   4. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ä–µ–ª–∏–∑ –Ω–∞ GitHub"
echo ""
echo "üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏:"
echo "   - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: README.md"
echo "   - –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥: https://github.com/i2p-gui"
echo "   - I2P Project: https://geti2p.net"

